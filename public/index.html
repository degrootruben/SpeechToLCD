<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./lib/p5.min.js"></script>
    <script src="./lib/p5.sound.min.js"></script>
    <title>SpeechToLCD</title>
</head>
<body>
    <script>
        let button;
        let mic;
        let soundRec;
        let soundFile;

        function setup() {
            mic = new p5.AudioIn();
            mic.start();
            soundRec = new p5.SoundRecorder();
            soundRec.setInput(mic);
            soundFile = new p5.SoundFile();

            button = createDiv("Click to record");
            button.position(100,100);
            button.size(100,100);
            button.style("background-color", "grey");


            button.mouseClicked((mouseEvent) => {
                button.html("Recording....");
                console.log("Recording....");
                soundRec.record(soundFile);

                let recordingTimer = setTimeout(() => {
                    soundRec.stop();
                    let audioBlob = soundFile.getBlob();

                    let formData = new FormData(); 
                    formData.append("audioBlob", audioBlob, "audio.wav");

                    var serverURL = "/upload_audio";
                    var httpRequestOptions = {
                        method: "POST",
                        body: formData,
                        headers: new Headers({
                        "enctype": "multipart/form-data"
                        })
                    };
                    httpDo(
                        serverURL,
                        httpRequestOptions,
                        successStatusCode => {
                            console.log("Uploaded recording successfully: " + successStatusCode);
                            button.html("Recording uploaded!");
                        },
                        error => { 
                            console.error(error);
                            button.html(error);
                        }
                    )
                    console.log("Recording stopped!");
                    button.html("Recording stopped!");
                },5000);

            });
        }
    </script>
</body>
</html>