<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeechToLCD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.min.js"></script>
    <script src="./lib/RecordRTC.min.js"></script>
</head>

<body>
    <div>
        <button id="start-recording" disabled>Start Recording</button>
        <button id="stop-recording" disabled>Stop Recording</button>
    </div>
    <textarea id="results" style="width: 800px; height: 300px;"></textarea>

    <script>
        const startRecording = document.getElementById('start-recording');
        const stopRecording = document.getElementById('stop-recording');
        let recordAudio;

        //2)
        const socketio = io();
        const socket = socketio.on('connect', function () {
            startRecording.disabled = false;
        });

        //3)
        startRecording.onclick = function () {
            startRecording.disabled = true;

            //4)
            navigator.getUserMedia({
                audio: true
            }, function (stream) {

                //5)
                recordAudio = RecordRTC(stream, {
                    type: 'audio',

                    //6)
                    mimeType: 'audio/webm',
                    sampleRate: 44100,
                    // used by StereoAudioRecorder
                    // the range 22050 to 96000.
                    // let us force 16khz recording:
                    desiredSampRate: 16000,

                    // MediaStreamRecorder, StereoAudioRecorder, WebAssemblyRecorder
                    // CanvasRecorder, GifRecorder, WhammyRecorder
                    recorderType: StereoAudioRecorder,
                    // Dialogflow / STT requires mono audio
                    numberOfAudioChannels: 1
                });

                recordAudio.startRecording();
                stopRecording.disabled = false;
            }, function (error) {
                console.error(JSON.stringify(error));
            });
        };

        stopRecording.onclick = function () {
            // recording stopped
            startRecording.disabled = false;
            stopRecording.disabled = true;

            // stop audio recorder
            recordAudio.stopRecording(function () {
                // after stopping the audio, get the audio data
                recordAudio.getDataURL(function (audioDataURL) {

                    //2)
                    var files = {
                        audio: {
                            type: recordAudio.getBlob().type || 'audio/wav',
                            dataURL: audioDataURL
                        }
                    };
                    // submit the audio file to the server
                    socketio.emit('message', files);
                });
            });
        };

        // 3)
        const resultpreview = document.getElementById('results');
        socketio.on('results', function (data) {
            console.log(data);
            // show the results on the screen
            if (data[0].queryResult) {
                resultpreview.innerHTML += "" + data[0].queryResult.fulfillmentText;
            }
        });

    </script>
</body>
</html>